from m5_tool import M5Model
import pandas as pd

def calibrate_from_file(observed_data_path, output_params='custom_params.json'):
    """
    Calibrate M5 model with user-provided data
    
    Parameters:
    -----------
    observed_data_path : str
        Path to CSV with columns: insert_length_bp, success_rate, n_replicates
    output_params : str
        Path to save calibrated parameters
    """
    
    model = M5Model.load_default()
    
    print("Calibrating model...")
    mae = model.calibrate(observed_data_path, params_to_fit=['a', 'b'])
    
    print(f"\nCalibration complete!")
    print(f"MAE: {mae:.3f}%")
    print(f"Updated parameters:")
    print(f"  a = {model.a:.4f}")
    print(f"  b = {model.b:.6f}")
    
    model.save(output_params)
    print(f"\nParameters saved to: {output_params}")
    
    return model


if __name__ == "__main__":
    import argparse
    
    parser = argparse.ArgumentParser(description='Calibrate M5 model')
    parser.add_argument('--data', type=str, required=True,
                        help='Path to observed data CSV')
    parser.add_argument('--output', type=str, default='custom_params.json',
                        help='Output parameters file')
    
    args = parser.parse_args()
    
    calibrate_from_file(args.data, args.output)